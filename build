#!/bin/bash

# Simple one-step Debian package builder for bash scripts
# Usage: ./build_deb.sh <your_script.sh> [package_name]

set -e

if [ $# -lt 1 ]; then
    echo "Usage: $0 <bash_script> [package_name]"
    echo "Example: $0 myscript.sh mytool"
    exit 1
fi

SCRIPT_PATH="$1"
SCRIPT_NAME=$(basename "$1")
PACKAGE_NAME="${2:-${SCRIPT_NAME%.*}}"
VERSION="1.0"
TEMP_DIR="/tmp/deb_build_$$"

cleanup() { rm -rf "$TEMP_DIR"; }
trap cleanup EXIT

echo "Building Debian package for: $SCRIPT_NAME"

# Create directories
mkdir -p "$TEMP_DIR/$PACKAGE_NAME/DEBIAN"
mkdir -p "$TEMP_DIR/$PACKAGE_NAME/usr/bin"

# Copy and prepare script
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "Error: Script not found!"
    exit 1
fi

cp "$SCRIPT_PATH" "$TEMP_DIR/$PACKAGE_NAME/usr/bin/$PACKAGE_NAME"
chmod +x "$TEMP_DIR/$PACKAGE_NAME/usr/bin/$PACKAGE_NAME"

# Ensure shebang
if ! head -1 "$TEMP_DIR/$PACKAGE_NAME/usr/bin/$PACKAGE_NAME" | grep -q "^#!"; then
    sed -i '1i#!/bin/bash' "$TEMP_DIR/$PACKAGE_NAME/usr/bin/$PACKAGE_NAME"
fi

# Create minimal control file
cat > "$TEMP_DIR/$PACKAGE_NAME/DEBIAN/control" << EOF
Package: $PACKAGE_NAME
Version: $VERSION
Section: utils
Priority: optional
Architecture: all
Depends: bash
Maintainer: $USER
Description: $SCRIPT_NAME
 This is an automated package for $SCRIPT_NAME.
EOF

# Build package
echo "Building package..."
dpkg-deb --build "$TEMP_DIR/$PACKAGE_NAME" "${PACKAGE_NAME}_${VERSION}_all.deb"

echo "Package created: ${PACKAGE_NAME}_${VERSION}_all.deb"
echo "Install: sudo dpkg -i ${PACKAGE_NAME}_${VERSION}_all.deb"
echo "Remove: sudo dpkg -r $PACKAGE_NAME"
